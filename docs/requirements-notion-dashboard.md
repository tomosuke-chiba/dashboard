# Notion案件進捗ダッシュボード 要件定義書

## 1. 概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Notion案件進捗 → 月次ノルマ可視化ダッシュボード |
| 目的 | Notionで管理している案件の進捗を集計し、月次ノルマ達成状況を可視化 |
| データソース | Notion API（Supabaseへの永続保存なし） |
| 更新方式 | 毎朝06:00 JST自動更新 + 手動更新ボタン |
| URLパス | `/dashboard/sales` |
| 認証方式 | パスワード認証（チーム共通パスワード1つ） |
| デプロイ先 | Vercel |
| 実装状況 | 一部実装 |

---

## 2. 目的・ゴール

Notionで管理している案件の進捗（ステータス・契約完了日）を集計し、以下を**視覚的に一目で把握**できるダッシュボードを提供する：

- **今月の成約数（＝契約完了）**
- **今月ノルマまで残り何件か**
- **達成率**
- **ヤギ（目標） vs 人（実績）のスコアボードで「勝ってる/負けてる」が一瞬でわかる**

運用は「ほぼ手作業OK」を前提にし、**データの正はNotion**とする（Supabaseへ永続保存しない）

---

## 3. 前提条件

| 項目 | 内容 |
|------|------|
| 成約定義 | **成約＝「✅契約完了」または「💰振込確認」** |
| 集計条件 | `ステータス = ✅契約完了 または 💰振込確認` AND `契約完了日` が当月（JST） |
| ノルマ | 月ごとに固定値（月別ノルマ表を使用） |
| 更新方式 | 毎朝06:00（JST）自動更新 + 手動更新ボタン |
| 認証 | パスワード認証（チーム共通パスワード1つ） |
| Notion設定 | `契約完了日`（Date）プロパティを追加済み |
| NotionデータベースID | `1af9364dd5c3816392f7f77a65dc55ba` |

---

## 4. Notionデータ要件

### 4.1 対象ステータス（8種類）

| ステータス | 用途 |
|------------|------|
| `リード` | ファネル表示（個別相談日程確定を含む） |
| `日程確定` | ファネル表示 |
| `提案・見積` | ファネル表示 |
| `返答待ち` | ファネル表示 |
| `✅契約完了` | **成約（主要KPI）** |
| `💰振込確認` | 参考KPI |
| `失注` | 補助指標 |
| `時期が来たら連絡` | 補助指標 |

### 4.2 必須プロパティ（案件DB）

| プロパティ名 | 型 | 用途 |
|--------------|-----|------|
| `案件名` | Title | 案件識別 |
| `ステータス` | Select/Status | ステータス判定 |
| `契約完了日` | Date | 月次成約の集計キー |

### 4.3 運用ルール（KPI精度担保）

- `ステータス` を `✅契約完了` に変更したら、**必ず同時に `契約完了日` を入力**
- 入力漏れ検知ビュー（Notion側で運用）
  - フィルタ例：`ステータス = ✅契約完了` かつ `契約完了日が空`

---

## 5. 月別ノルマ

当月（JST）の月番号をキーに、以下のノルマを適用：

| 月 | ノルマ |
|----|--------|
| 1月 | 6 |
| 2月 | 7 |
| 3月 | 7 |
| 4月 | 7 |
| 5月 | 8 |
| 6月 | 8 |
| 7月 | 9 |
| 8月 | 9 |
| 9月 | 9 |
| 10月 | 10 |
| 11月 | 10 |
| 12月 | 10 |

---

## 6. 集計ロジック

### 6.1 今月成約数

```
ステータス = ✅契約完了 または 💰振込確認 AND 契約完了日 が当月（JST）
```

### 6.2 残り件数

```
max(ノルマ - 今月成約数, 0)
```

### 6.3 達成率

```
今月成約数 / ノルマ
```

### 6.4 達成見込み（簡易予測）

```
予測成約 = 今月成約数 / 経過日数 * 当月日数
予測成約 >= ノルマ なら「達成見込み」
```

> 注：精度より"分かりやすさ優先"。加重パイプライン等は将来拡張。UIでは表示しない。

---

## 7. 画面要件（UI/UX）

### 7.1 スコアボード（最上段・最重要）

**目的：左の例のように「勝ってる/負けてる」が一瞬で分かる。**
**表現：ヤギ＝目標（Target）、人＝実績（Actual）。**

#### 表示仕様（必須）

- チャート種別：**折れ線（累積）2系列**
  - **ヤギ（目標）＝目標累積ライン**
  - **人（実績）＝実績累積ライン**
- X軸：当月の日付（1日〜月末）
- 年間表示の場合は「1〜12月」を表示
- 年間表示の場合はY軸を0〜12に固定
- Y軸：累積成約数（0〜ノルマ上限を含む）
- 今日（JST）時点の比較を明示：
  - `実績累積 >= 目標累積` → **先行（勝ち）**
  - `実績累積 < 目標累積` → **遅れ（負け）**
- チャート上に**アイコンを必ず載せる**
  - 目標線の最新点にヤギアイコン
  - 実績線の最新点に人アイコン

#### 目標線（ヤギ）の定義（MVP）

```
targetCum(d) = target * (d / daysInMonth)
```

#### 実績線（人）の定義（MVP）

- `契約完了日` を日別に集計し、当月の「日別成約数」を作る
- 1日〜月末まで累積して「実績累積値」を作る

#### UX要件（必須）

- ツールチップで日付・目標累積・実績累積・差分を表示
- 凡例は短く固定（例：ヤギ＝目標 / 人＝実績）
- モバイルではチャートが潰れないこと（横スクロール or 自動圧縮）

### 7.2 トップKPI（スコアボード直下）

| 項目 | 表示内容 |
|------|----------|
| リード件数 | リード＋日程確定の合算を表示（年間表示では年間リード） |
| 今月成約数 | 成約数を表示（年間表示では年間成約数） |
| 今月ノルマ | 月別ノルマ値（年間表示では年間ノルマ合計） |
| 残り件数 | ノルマ − 成約（0未満は0表示） |
| 達成率 | 成約 ÷ ノルマ（%表示） |
| 達成見込み | 表示しない |
| ペース判定 | 表示しない |

### 7.3 ファネル/ステータス別サマリ

- ステータス別件数（8ステータス）
- 主要遷移の簡易ファネル（任意）
  - リード → 日程確定 → 提案・見積 → 返答待ち → ✅契約完了

### 7.4 一覧（MVP外でもOK）

- ステータス別の案件一覧
- Notionへの導線リンク

### 7.5 更新UI

| 要素 | 内容 |
|------|------|
| 最終更新表示 | `YYYY/MM/DD HH:mm JST` |
| 更新ボタン | `最新に更新` |
| 押下中 | ローディング・ボタン無効化 |
| 完了 | 成功トースト |
| 失敗 | 失敗トースト（前回キャッシュがあれば表示継続） |

---

## 8. 更新方式

### 8.1 自動更新（1日1回）

- 毎日 **06:00 JST** に集計を実行
- ダッシュボード表示用の結果を更新

### 8.2 手動更新

- UIの `最新に更新` ボタンで集計を即時実行
- パスワード認証済みユーザーのみ利用可能
- 連打対策：1分以内の再実行は拒否

### 8.3 パスワード認証

- ダッシュボードへのアクセス時にパスワード入力を要求
- チーム共通の固定パスワード1つで運用
- セッション維持：ブラウザを閉じるまで有効（または24時間）
- パスワードは環境変数で管理

---

## 9. API仕様

### 9.1 集計取得

```
GET /api/dashboard/summary
```

**クエリ:**
- `year` (任意): 4桁の年
- `month` (任意): 1〜12 or `0`/`all`（`0`/`all` は年間集計）

**レスポンス例:**

```json
{
  "thisMonthContracts": 5,
  "target": 8,
  "remaining": 3,
  "achievementRate": 0.625,
  "forecast": "達成見込み",
  "paceStatus": "先行",
  "scoreboard": {
    "month": "2025-12",
    "daysInMonth": 31,
    "today": "2025-12-31",
    "series": [
      { "date": "2025-12-01", "targetCum": 0.3, "actualCum": 0 },
      { "date": "2025-12-02", "targetCum": 0.5, "actualCum": 1 }
    ]
  },
  "statusCounts": {
    "リード": 12,
    "日程確定": 8,
    "提案・見積": 5,
    "返答待ち": 3,
    "✅契約完了": 5,
    "💰振込確認": 2,
    "失注": 4,
    "時期が来たら連絡": 6
  },
  "lastRefreshedAt": "2025-01-15T06:00:00+09:00"
}
```

### 9.2 更新実行

```
POST /api/dashboard/refresh
```

**クエリ:**
- `year` (任意): 4桁の年
- `month` (任意): 1〜12 or `0`/`all`（`0`/`all` は年間集計）

**処理フロー:**
1. Notion API取得
2. 集計処理
3. キャッシュ更新

**制御:**
- 連打対策（1分以内の再実行は拒否）
- 失敗時：エラー応答（前回キャッシュがあれば表示継続）

---

## 10. 技術要件

### 10.1 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Next.js 16.1.1 + React 19 + Tailwind CSS |
| チャート | recharts |
| 日付処理 | date-fns |
| データ取得 | Notion API |
| 定期実行 | Vercel Cron（06:00 JST） |
| キャッシュ | アプリ側キャッシュ（24h相当） |

### 10.2 データ取得

- Notion APIで案件DBを取得（Query）
- 取得範囲は「必要最小限」（当月集計に必要なプロパティ）

### 10.3 キャッシュ戦略

- 集計結果はアプリ側キャッシュとして保持（24h相当）
- Supabaseへの永続保存は行わない
- Notion APIが失敗した場合でも、キャッシュがあれば表示継続

---

## 11. 非機能要件

| 項目 | 要件 |
|------|------|
| パフォーマンス | 通常表示は高速（キャッシュから即返却） |
| 可用性 | Notion障害時も前回データ表示で業務継続 |
| セキュリティ | refreshにレート制限（悪用・コスト増対策） |

---

## 12. 画面構成

```
/dashboard/sales              → ノルマダッシュボード（メイン）
/api/dashboard/summary        → 集計データ取得API
/api/dashboard/refresh        → 更新実行API
/api/dashboard/auth           → パスワード認証API
```

---

## 13. 環境変数

```
NOTION_API_KEY               # Notion API キー
NOTION_DATABASE_ID           # 案件DB ID（1af9364dd5c3816392f7f77a65dc55ba）
DASHBOARD_PASSWORD           # ダッシュボードアクセス用パスワード
```

---

## 14. 実装タスク

### Phase 1: 基盤構築

- [ ] Notion APIクライアント実装
- [ ] 環境変数設定（NOTION_API_KEY, NOTION_DATABASE_ID, DASHBOARD_PASSWORD）
- [ ] キャッシュ機構実装（メモリ or ファイルベース）

### Phase 2: 認証実装

- [ ] パスワード認証API（/api/dashboard/auth）
- [ ] 認証状態管理（セッション/Cookie）
- [ ] 認証画面UI（パスワード入力フォーム）

### Phase 3: API実装

- [ ] GET /api/dashboard/summary 実装
- [ ] POST /api/dashboard/refresh 実装
- [ ] レート制限（連打対策）実装
- [ ] Vercel Cron設定（06:00 JST）

### Phase 4: UI実装

- [ ] ダッシュボードページ（/dashboard/sales）
- [ ] スコアボードチャート（ヤギ=目標 / 人=実績）
- [ ] トップKPIカード（成約数・ノルマ・残り・達成率）
- [ ] 年間表示（2026年通年）と1〜12月の切替
- [ ] ステータス別サマリー
- [ ] ファネルチャート（recharts）
- [ ] 更新ボタン・最終更新表示
- [ ] トースト通知

### Phase 5: 仕上げ

- [ ] エラーハンドリング（Notion障害時のフォールバック）
- [ ] ローディング状態
- [ ] レスポンシブ対応

---

## 15. 受け入れ基準（Done定義）

- [ ] パスワード認証でダッシュボードにアクセスできる
- [ ] 毎朝06:00 JSTに更新され、ダッシュボードに反映される
- [ ] 手動更新ボタンで即時更新できる
- [ ] 今月成約が「✅契約完了/💰振込確認」の条件で一致する
- [ ] 月別ノルマが当月に応じて正しく表示され、残り件数が正しく計算される
- [ ] Notion APIが一時的に失敗しても、前回キャッシュがある場合は表示継続できる
- [ ] スコアボードに線が2本のみ表示される（ヤギ=目標 / 人=実績）
- [ ] ヤギが必ず目標線、人が必ず実績線に紐づいて表示される（取り違え不可）
- [ ] ツールチップで日付・目標累積・実績累積・差分が確認できる

---

## 16. スコープ外（今回やらない）

- Notionのステータスを自動更新する連携（CloudSign連携含む）
- Supabaseへ案件を永続保存して履歴分析する仕組み
- 月別ノルマを管理画面/Notionで編集できる機能（固定値で運用）
- 目標線を営業日ベースや重み付きにする高度化

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-12-31 | 初版作成 |
| 2025-12-31 | パスワード認証追加、URLパス確定（/dashboard/sales）、NotionデータベースID確定 |
