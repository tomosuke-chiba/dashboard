# 要件定義書

## プロジェクト概要

**プロジェクト名**: 求人媒体ダッシュボード
**クライアント**: 株式会社KOU
**作成日**: 2024年12月29日
**最終更新日**: 2025年12月30日

---

## 1. 事業背景

### 1.1 株式会社KOUについて

| 項目 | 内容 |
|------|------|
| 会社名 | 株式会社KOU |
| 代表 | 千葉共将 |
| 事業内容 | 歯科医院向け採用支援サービス |
| サービス名 | SNS × 求人媒体 ハイブリッド採用支援サービス |

### 1.2 事業KPI

**最重要指標: 採用性効率（コスト対効果）**

### 1.3 ダッシュボード閲覧者

- **貴社担当者のみ**（クライアントには共有しない）
- → 複雑な権限管理は不要

---

## 2. 対象媒体と課金体系

### 2.1 媒体一覧

| 媒体 | 課金体系 | 採用決定の流れ |
|------|----------|----------------|
| **GUPPY** | 閲覧課金（100円/閲覧）+ スカウトメール（1,000円/通） | 表示→閲覧→申込 or スカウト→返信→採用 |
| **ジョブメドレー** | 閲覧無料 + スカウト月100通無料 | 検索順位上位化→閲覧→申込 |
| **クオキャリア** | プロフィール変更不可 | スカウトメール最適化が重要 |

### 2.2 職種

**対象職種（全9職種）:**
1. Dr（歯科医師）
2. DH（歯科衛生士）
3. DA（歯科助手）
4. 受付
5. 歯科技工士
6. 管理栄養士
7. 保育士
8. 幼稚園教諭
9. 医療事務

**開発優先度:**
- **Phase 1**: Dr / DH / DA（主要3職種）
- **Phase 2**: 残り6職種

### 2.3 データ管理の粒度

**3軸管理: クリニック × 媒体 × 職種**

**閲覧したいデータ階層:**
1. **個別詳細:** 各クリニック × 各媒体 × 各職種
2. **媒体合計:** 各クリニック × 各媒体
3. **全体集計:** 全クリニック × 各職種 の総合計

→ **ドリルダウン可能な構造**が必要

---

## 3. 開発フェーズ

### Phase 1: GUPPY追加機能（最優先）

| 機能 | 詳細 | ステータス |
|------|------|------------|
| 職種別データ取得 | Dr / DH / DA のタブ/フィルター切り替えで取得 | ✅実装済み |
| スカウトメール送信数 | `/service/message_thread?filter_tab=scout_no_reply` から取得 | ✅実装済み |
| スカウトメール返信数 | 差分計算（全スカウト - 未返信 = 返信あり） | ✅実装済み |
| 閲覧率30%超アラート | Discord通知で警告 | ✅実装済み |
| Bitly連携 | API連携でクリック数自動取得 | ✅実装済み |

### Phase 2: ジョブメドレー対応

| 機能 | 詳細 | ステータス |
|------|------|------------|
| 検索順位取得 | 検索順位の上位化が最重要 | 未実装 |
| スカウトメール返信率 | 月100通無料スカウトの効果計測 | 未実装 |
| 職種別データ | クリニックごとに異なる職種を出稿 | 未実装 |

### Phase 3: クオキャリア対応

| 機能 | 詳細 | ステータス |
|------|------|------------|
| スカウトメール開封率 | プラットフォームから取得可能 | 未実装 |
| スカウトメール返信率 | どのスカウト文面が効果的か最適化 | 未実装 |

---

## 4. 機能要件（詳細）

### 4.1 GUPPY

#### 4.1.1 閲覧データ（実装済み → 職種別に拡張必要）

| 項目 | ソース | 更新頻度 | 職種別 |
|------|--------|----------|--------|
| 表示数 | `/service/access_logs/YYYY-MM` | 6時間ごと（1日4回） | 要対応 |
| 閲覧数 | 同上 | 6時間ごと | 要対応 |
| 自社サイト誘導数 | 同上 | 6時間ごと | 要対応 |
| 応募数 | 同上 | 6時間ごと | 要対応 |

**計算項目:**
- 閲覧率 = 閲覧数 / 表示数
- **アラート条件: 閲覧率 > 30% で不正アクセス疑い → Discord通知**

#### 4.1.2 スカウトメール（新規実装）

| 項目 | ソース | 備考 |
|------|--------|------|
| 送信数 | `/service/message_thread?filter_tab=scout_no_reply` | 「もっと見る」で全データ取得、日時から集計 |
| 返信数 | `/service/message_thread` | 返信ありのスレッド数 |
| 既読数 | - | **不要**（取得コスト高） |

**計算項目:**
- 返信率 = 返信数 / 送信数

#### 4.1.3 Bitly連携（新規実装）

| 項目 | 詳細 |
|------|------|
| プラン | 有料プラン利用中 → API連携可能 |
| URL管理 | クリニックごとに1つの短縮URLを使い回し |
| 現状管理 | Bitly管理画面で個別確認中 |
| 対応方針 | クリニックごとのBitly URLをDB登録し、API経由でクリック数取得 |

### 4.2 ジョブメドレー

| 項目 | 重要度 | 備考 |
|------|--------|------|
| 検索順位 | **最重要** | 閲覧無料のため、順位上位化が命題 |
| スカウトメール返信率 | 重要 | 月100通無料、競合優位性は低い |

### 4.3 クオキャリア

| 項目 | 重要度 | 備考 |
|------|--------|------|
| スカウトメール開封率 | 重要 | プラットフォームから取得可能 |
| スカウトメール返信率 | 重要 | どの文面が効果的か最適化 |
| プロフィール変更 | - | **不可**（唯一変更できない媒体） |

---

## 5. アラート・通知機能

### 5.1 通知一覧

| トリガー | 通知先 | 内容 | ステータス |
|----------|--------|------|------------|
| 新規応募 | Discord | クライアント名 + 「新規応募あり」 | 実装済み |
| 閲覧率30%超 | Discord | クライアント名 + 「不正アクセス疑い」警告 | **未実装** |

---

## 6. データ更新頻度

| 項目 | 頻度 |
|------|------|
| 閲覧データ（表示数・閲覧数など） | **1日4回**（6時間ごと） |
| 検索順位 | 1日1回 |

---

## 7. データベース設計（更新版）

### 7.1 テーブル構成

#### clinics（クライアント情報）

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | TEXT | クライアント名（歯科医院名） |
| slug | TEXT | URL用スラッグ（ユニーク） |
| guppy_login_id | TEXT | GUPPYログインID |
| guppy_password | TEXT | GUPPYパスワード |
| guppy_clinic_name | TEXT | GUPPY上の医院名（検索順位マッチング用） |
| guppy_search_url | TEXT | 検索順位チェック用の地区URL |
| jobmedley_login_id | TEXT | ジョブメドレーログインID |
| jobmedley_password | TEXT | ジョブメドレーパスワード |
| quacareer_login_id | TEXT | クオキャリアログインID |
| quacareer_password | TEXT | クオキャリアパスワード |
| **bitly_url** | TEXT | **Bitly短縮URL（新規追加）** |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### metrics（メトリクスデータ）- 更新版

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_id | UUID | クライアントID（外部キー） |
| date | DATE | 記録日 |
| source | TEXT | 媒体（'guppy', 'jobmedley', 'quacareer'） |
| **job_type** | TEXT | **職種（'dr', 'dh', 'da' など）（新規追加）** |
| search_rank | INTEGER | 検索順位 |
| display_count | INTEGER | 表示数 |
| view_count | INTEGER | 閲覧数 |
| redirect_count | INTEGER | 自社サイト誘導数 |
| application_count | INTEGER | 応募数 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

**ユニーク制約: clinic_id + date + source + job_type**

#### scout_messages（スカウトメールデータ）- 新規テーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_id | UUID | クライアントID（外部キー） |
| date | DATE | 記録日 |
| source | TEXT | 媒体（'guppy', 'jobmedley', 'quacareer'） |
| sent_count | INTEGER | 送信数 |
| reply_count | INTEGER | 返信数 |
| open_count | INTEGER | 開封数（クオキャリアのみ） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

**ユニーク制約: clinic_id + date + source**

#### bitly_clicks（Bitlyクリックデータ）- 新規テーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| clinic_id | UUID | クライアントID（外部キー） |
| date | DATE | 記録日 |
| click_count | INTEGER | クリック数 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

**ユニーク制約: clinic_id + date**

---

## 8. 現状の実装状況

### 8.1 実装済み

- [x] GUPPYからのデータ取得（表示数・閲覧数・誘導数・応募数）
- [x] クライアント別ダッシュボード（`/clinic/[slug]/guppy`）
- [x] 社内管理ページ（`/admin`、パスワード認証）
- [x] Discord通知（新規応募時）
- [x] 履歴データ保存・月別表示
- [x] 17クリニック登録済み

### 8.2 Phase 1 実装済み

- [x] 職種別データ取得（Dr / DH / DA）
- [x] スカウトメール送信数・返信数
- [x] 閲覧率30%超アラート（Discord通知）
- [x] Bitly API連携
- [ ] 更新頻度を1日4回に変更（Vercel Cron設定）

### 8.3 未実装（Phase 2以降）

- [ ] ジョブメドレー連携
- [ ] クオキャリア連携
- [ ] 残り6職種の対応
- [ ] 全クリニック×全職種の集計ダッシュボード

---

## 9. 画面構成

```
/                           → トップページ（リダイレクト）
/admin                      → 社内管理ページ（パスワード認証）
/clinic                     → クライアント一覧
/clinic/[slug]              → クライアント別サマリー
/clinic/[slug]/guppy        → GUPPYダッシュボード（職種別タブ追加予定）
/clinic/[slug]/job-medley   → ジョブメドレーダッシュボード（Coming Soon）
/clinic/[slug]/quacareer    → クオキャリアダッシュボード（Coming Soon）
/api/scrape                 → スクレイピング実行API
/api/clinics                → クライアント一覧API
/api/clinics/[slug]         → クライアント詳細API
```

---

## 10. 技術スタック

| レイヤー | 技術 |
|----------|------|
| フロントエンド | Next.js 16 + React 19 + Tailwind CSS |
| バックエンド | Next.js API Routes |
| スクレイピング | Playwright |
| データベース | Supabase (PostgreSQL) |
| 定期実行 | Vercel Cron（6時間ごと = 1日4回） |
| ホスティング | Vercel |
| 通知 | Discord Webhook |
| URL短縮 | Bitly API |

---

## 11. 環境変数

```
NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY
DISCORD_WEBHOOK_URL
ADMIN_PASSWORD
CRON_SECRET
NEXT_PUBLIC_BASE_URL
BITLY_ACCESS_TOKEN          # 新規追加
```

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2024-12-29 | 初版作成 |
| 2024-12-29 | GUPPY取得項目を8項目に確定 |
| 2025-12-30 | 大幅更新: 職種別対応、スカウトメール機能、Bitly連携、閲覧率アラート、3媒体の詳細要件追加 |