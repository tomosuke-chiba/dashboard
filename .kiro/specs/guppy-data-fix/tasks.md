# Implementation Plan: guppy-data-fix

## Tasks

- [x] 1. APIにソースフィルタリング機能を追加
- [x] 1.1 クエリパラメータからソース値を取得しバリデーションする
  - リクエストURLから`source`パラメータを抽出
  - 有効な値（`guppy`、`jobmedley`、`quacareer`）のみ受け付ける
  - 無効な値の場合は400エラーを返却する
  - `source`パラメータが省略された場合は従来動作を維持（後方互換性）
  - _Requirements: 1.1, 1.4, 6.2, 6.3_

- [x] 1.2 メトリクスクエリにソースフィルタを適用する
  - `metrics`テーブルへのクエリに`.eq('source', source)`を追加
  - ソースパラメータが指定された場合のみフィルタを適用
  - 月フィルタ・職種フィルタとの組み合わせが正しく動作することを確認
  - _Requirements: 1.1, 2.1, 2.2, 2.3_

- [x] 1.3 スカウトメッセージクエリにソースフィルタを適用する
  - `scout_messages`テーブルへのクエリに`.eq('source', source)`を追加
  - ソースパラメータが指定された場合のみフィルタを適用
  - _Requirements: 1.2, 4.1, 4.4_

- [x] 1.4 Bitlyリンククエリにソースフィルタを適用する
  - `bitly_links`テーブルへのクエリに`.eq('source', source)`を追加
  - リンク別クリックデータもソースでフィルタリング
  - _Requirements: 1.3, 4.2, 4.3_

- [x] 1.5 利用可能月リストをソース別に取得する
  - `availableMonths`取得クエリにソースフィルタを追加
  - 指定ソースのデータが存在する月のみを返却
  - 降順ソート（最新月が先頭）を維持
  - _Requirements: 5.1, 5.3_

- [ ] 2. GUPPYページからAPIにソースパラメータを送信
- [x] 2.1 データ取得リクエストに`source=guppy`を追加する
  - `fetch`URL に`source=guppy`クエリパラメータを付与
  - 既存の`month`、`job_type`パラメータとの組み合わせを維持
  - _Requirements: 1.1, 2.1, 3.1, 3.2, 3.3, 4.1_

- [x] 2.2 利用可能月リストが空の場合のUI対応を確認する
  - 月選択UIが0件でも正しく動作することを確認
  - データがない場合の表示メッセージを確認
  - _Requirements: 2.4, 5.2_

- [ ] 3. 統合テストと動作確認
- [x] 3.1 GUPPYページでデータが正しく表示されることを確認する
  - 日別テーブルにGUPPYデータのみが表示される
  - サマリーカードの集計値がGUPPYデータのみを反映
  - スカウトメールセクションにGUPPYデータが表示される
  - 月選択でGUPPYデータのある月のみが選択可能
  - _Requirements: 2.1, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2_

- [x] 3.2 後方互換性を確認する
  - `source`パラメータなしでAPIを呼び出した場合、従来動作を維持
  - 既存の呼び出し元（トップページ等）に影響がないことを確認
  - _Requirements: 1.4_

- [x] 3.3 エラーハンドリングを確認する
  - 無効な`source`値で400エラーが返却される
  - データベース接続エラー時に503が返却される
  - クリニック未発見時に404が返却される
  - ローディング状態が正しく表示される
  - _Requirements: 6.1, 6.2, 6.3, 6.4_
