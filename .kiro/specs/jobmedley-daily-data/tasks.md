# Implementation Plan

## Tasks

- [x] 1. データベーススキーマの拡張
- [x] 1.1 jobmedley_scoutsテーブルへのカラム追加
  - 求人ID、閲覧数、応募数（全体・スカウト経由）、累計送信数、検索順位カラムを追加
  - clinic_id + job_offer_id + date の複合ユニーク制約を設定
  - job_offer_id にインデックスを作成
  - _Requirements: 6.1, 6.3_

- [x] 1.2 jobmedley_job_offersテーブルの新規作成
  - 求人マスタテーブルを作成（ID、名称、採用決定数、応募数、閲覧数等8項目）
  - clinic_id + job_offer_id の複合ユニーク制約を設定
  - RLSポリシーを追加
  - _Requirements: 6.2_

- [x] 2. スクレイパー基盤の拡張
- [x] 2.1 (P) APIフェッチャーの実装
  - ジョブメドレーAPI `/api/customers/statistics/total/` から日別データを取得する機能を実装
  - period_type=2 パラメータで月間データを取得
  - pv_data、apply_data、apply_from_scout_data を日別で解析
  - APIエラー時はログ記録して処理継続
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2.2 (P) 求人リストスクレイパーの実装
  - 分析ページの検索欄サジェストから求人リストを取得
  - 各求人のID・名称を抽出
  - 新規求人の自動検出と追加
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 2.3 求人別サマリースクレイパーの実装
  - 各求人選択時に8項目のサマリーデータを取得
  - 採用決定数、応募数、スカウト経由応募数、閲覧数、原稿更新日数、写真枚数、特徴タグ、スカウト送信数
  - 求人IDに紐づけてデータを管理
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 2.4 スカウト送信数ホバースクレイパーの実装
  - スカウト送信数グラフの各日ドットをホバーして累計値を取得
  - 毎日23:00 JST基準で月間累計を記録
  - 前日との差分計算で日別送信数を算出（月初・リセット検知対応）
  - 職種ごと（求人ごと）に送信数を取得
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 2.5 検索順位スクレイパーの実装
  - 職種ごとの検索一覧URLから医院名の表示順位を取得
  - デフォルト表示での通算順位（1始まり）を計測
  - 複数件存在時は最上位を採用、見つからない場合はnullを保存
  - 職種URL未設定時のエラーハンドリング
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 3. スクレイパー統合とデータ保存
- [x] 3.1 メインスクレイパーの統合
  - 各スクレイパーコンポーネントを統合した日次バッチ処理を実装
  - ログイン → 求人リスト取得 → 各求人ループ（API・ホバー・順位）の処理フロー
  - 23:00 JST実行のCronジョブ設定
  - _Requirements: 2.4_

- [x] 3.2 データベース保存処理の実装
  - 日別メトリクスのUPSERT処理（jobmedley_scouts）
  - 求人マスタのUPSERT処理（jobmedley_job_offers）
  - エラー時のログ記録と処理継続
  - _Requirements: 1.4, 6.1, 6.2, 6.3_

- [x] 4. APIエンドポイントの拡張
- [x] 4.1 日別データAPI の実装
  - `/api/jobmedley` エンドポイントで日別データを返却
  - year, month, slug, job_offer_id パラメータ対応
  - job_offer_id 未指定時は全求人合算データを返却
  - 率計算用の生値を返却（分母0対策含む）
  - _Requirements: 10.1, 10.2, 10.3, 10.4_

- [x] 4.2 (P) 求人リストAPI の実装
  - `/api/jobmedley/job-offers` エンドポイントで求人リストを返却
  - slug パラメータでクリニックフィルタリング
  - 求人ID・名称の一覧を返却
  - _Requirements: 10.1_

- [x] 5. フロントエンドUIの実装
- [x] 5.1 求人選択ドロップダウンの実装
  - 求人選択UIコンポーネントを作成
  - デフォルトで「全求人合算」を選択
  - 選択変更時にAPIリクエストを発火してデータを更新
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 5.2 日別テーブルの実装
  - 8項目×31行のテーブルコンポーネントを作成
  - 日付、送信数、スカウト経由応募数、スカウト応募率、検索順位、閲覧数、求人ページ経由応募数、求人ページ経由応募率を表示
  - ゼロ除算時は「—」表示、データなし日付は空欄または0を表示
  - ダーク/ライトモード対応
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 5.3 (P) 求人別サマリーカードの実装
  - 8項目のサマリーカードコンポーネントを作成
  - 採用決定数、応募数、スカウト経由応募数、閲覧数、原稿更新日数、写真枚数、特徴タグ、スカウト送信数を表示
  - 求人選択時に該当求人の情報を表示
  - ダーク/ライトモード対応
  - _Requirements: 9.1, 9.2, 9.3, 9.4_

- [x] 6. 統合とテスト
- [x] 6.1 ページ統合
  - JobMedleyPageに全コンポーネントを統合
  - 求人切り替え時のデータフェッチとUI更新を接続
  - エラーハンドリングとローディング状態の実装
  - _Requirements: 8.4_

- [x] 6.2 差分計算ロジックのユニットテスト
  - 通常日の差分計算テスト
  - 月初リセットの計算テスト
  - 累計値リセット検知のテスト
  - _Requirements: 4.3_

- [x] 6.3 率計算ロジックのテスト
  - スカウト応募率の計算テスト
  - 求人ページ経由応募率の計算テスト
  - ゼロ除算時の表示テスト
  - _Requirements: 7.3_

## Requirements Coverage

| Requirement | Task(s) |
|-------------|---------|
| 1.1, 1.2, 1.3, 1.4, 1.5 | 2.1, 3.2 |
| 2.1, 2.2, 2.3, 2.4 | 2.2, 3.1 |
| 3.1, 3.2, 3.3 | 2.3 |
| 4.1, 4.2, 4.3, 4.4, 4.5 | 2.4 |
| 5.1, 5.2, 5.3, 5.4, 5.5 | 2.5 |
| 6.1, 6.2, 6.3 | 1.1, 1.2, 3.2 |
| 7.1, 7.2, 7.3, 7.4 | 5.2, 6.3 |
| 8.1, 8.2, 8.3, 8.4 | 5.1, 6.1 |
| 9.1, 9.2, 9.3, 9.4 | 5.3 |
| 10.1, 10.2, 10.3, 10.4 | 4.1, 4.2 |
