# 要件定義: data-fetch-enhancement

## 概要
GUPPY/JobMedleyのデータ取得機能を強化し、全クリニックで日別データと検索順位の推移を正確に表示できるようにする。

## 背景・課題

### 現状の問題点
1. **JobMedley日別データが取得されていない**
   - `/api/scrape` で `scrapeJobMedley`（月間サマリーのみ）を呼び出している
   - `scrapeJobMedleyDailyBatch`（日別データ取得）が呼ばれていない
   - `jobmedley_scouts` テーブルにデータが保存されない
   - 結果: 12月以外の月で「0」表示

2. **検索順位の日別推移が表示されない**
   - 検索順位は `metrics.search_rank` に保存される
   - UIでは最新の順位のみ表示
   - 日別推移のグラフ/テーブルがない

3. **全クリニック対応が不完全**
   - クレデンシャル（login_id/password）が設定されていないクリニックはスキップ
   - 設定されているクリニックでも日別データが取得されない

---

## 機能要件

### REQ-1: JobMedley日別データ取得の有効化
| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-1.1 | `/api/scrape` で `scrapeJobMedleyDailyBatch` を呼び出し、日別メトリクスを取得・保存する | P0 |
| REQ-1.2 | 日別データを `jobmedley_scouts` テーブルにUPSERTする | P0 |
| REQ-1.3 | 全求人合算（job_offer_id=null）のデータを取得する | P0 |
| REQ-1.4 | 過去月のデータも取得できるようにする（月指定パラメータ対応） | P1 |

### REQ-2: 検索順位の日別推移表示
| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-2.1 | JobMedleyページで検索順位の日別推移をテーブル表示する | P0 |
| REQ-2.2 | 日別データテーブル内の「検索順位」カラムに値を表示する | P0 |
| REQ-2.3 | 検索順位が未取得（null）の場合は「—」と表示する | P0 |
| REQ-2.4 | 検索順位のトレンド（上昇/下降/維持）を視覚的に表示する | P2 |

### REQ-3: GUPPYデータ取得の確認・修正
| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-3.1 | GUPPYの日別メトリクス取得が正常に動作することを確認する | P0 |
| REQ-3.2 | GUPPYのスカウトメール取得が正常に動作することを確認する | P1 |
| REQ-3.3 | `source=guppy` フィルタリングが正しく適用されることを確認する | P0 |

### REQ-4: 全クリニック対応
| ID | 要件 | 優先度 |
|----|------|--------|
| REQ-4.1 | クレデンシャルが設定された全クリニックでデータ取得を実行する | P0 |
| REQ-4.2 | スクレイピング結果をログ出力し、成功/失敗を追跡可能にする | P1 |
| REQ-4.3 | エラー発生時は該当クリニックをスキップし、他のクリニックは継続処理する | P0 |

---

## 非機能要件

### NFR-1: パフォーマンス
- スクレイピングはクリニック間で順次実行（並列実行による負荷回避）
- 1クリニックあたりのタイムアウト: 5分
- 全体実行時間: 30分以内（10クリニック想定）

### NFR-2: 信頼性
- スクレイピング失敗時はリトライなし（次回実行で再取得）
- データ欠損時は既存データを上書きしない
- UPSERT使用による冪等性確保

### NFR-3: 可観測性
- スクレイピング実行ログをコンソール出力
- Discord通知（オプション）: 重大エラー発生時

---

## 影響範囲

### 変更対象ファイル
| ファイル | 変更内容 |
|----------|----------|
| `src/app/api/scrape/route.ts` | `scrapeJobMedleyDailyBatch` 呼び出し追加 |
| `src/app/clinic/[slug]/job-medley/page.tsx` | 検索順位表示の改善 |
| `src/lib/jobmedley-db.ts` | 必要に応じてDB保存ロジック調整 |

### データベース
- 新規テーブル: なし
- 既存テーブル変更: なし
- データ追加: `jobmedley_scouts` に日別データ挿入

---

## テスト計画

### 単体テスト
- [ ] `scrapeJobMedleyDailyBatch` の呼び出し確認
- [ ] `upsertDailyMetrics` のデータ保存確認

### 結合テスト
- [ ] `/api/scrape?source=jobmedley` 実行後、`jobmedley_scouts` にデータが保存される
- [ ] JobMedleyページで日別データが表示される
- [ ] 検索順位が日別テーブルに表示される

### E2Eテスト
- [ ] 全クリニックのJobMedleyページで過去月のデータが表示される
- [ ] 検索順位の推移が確認できる

---

## 完了条件
1. JobMedleyページで全ての月のデータ（採用決定数・応募数・スカウト経由応募数・閲覧数）が表示される
2. 日別データテーブルに検索順位が表示される
3. 全クリニックで同様の機能が動作する
4. ビルドエラーなし
